[
  {
    "path": "components/AwaitingActivationPage.tsx",
    "content": "\nimport React, { useState } from 'react';\nimport { Button } from './ui/Button';\nimport { Card } from './ui/Card';\nimport type { UserProfile } from '../types';\n\ninterface AwaitingActivationPageProps {\n  user: UserProfile | null;\n  onLogout: () => void;\n  logoUrl: string | null;\n}\n\nexport const AwaitingActivationPage: React.FC<AwaitingActivationPageProps> = ({ user, onLogout, logoUrl }) => {\n    const [notified, setNotified] = useState(false);\n    const [isLoading, setIsLoading] = useState(false);\n\n    const handleNotifyAdmin = () => {\n        setIsLoading(true);\n        // Simulate sending an email\n        console.log(`Notifying admin to activate account for: ${user?.email}`);\n        setTimeout(() => {\n            setNotified(true);\n            setIsLoading(false);\n        }, 1500);\n    };\n\n  return (\n    <div className=\"min-h-screen bg-gray-100 flex flex-col justify-center items-center p-4\">\n       <header className=\"absolute top-0 left-0 right-0 p-4 flex justify-between items-center\">\n        <img src={logoUrl || '/logo.png'} alt=\"LIDIA Logo\" className=\"h-10\" />\n        <Button onClick={onLogout} variant=\"secondary\">Sair</Button>\n      </header>\n      <Card className=\"w-full max-w-lg text-center\">\n        <h2 className=\"text-2xl font-bold text-gray-800 mb-4\">Quase lá!</h2>\n        <p className=\"text-gray-600 mb-6\">\n          Sua conta foi criada com sucesso! Estamos validando sua assinatura e seu acesso será liberado em breve.\n        </p>\n        {!notified ? (\n            <Button onClick={handleNotifyAdmin} isLoading={isLoading}>\n                POR FAVOR ATIVE MINHA CONTA\n            </Button>\n        ) : (\n            <p className=\"text-green-600 font-semibold bg-green-100 p-3 rounded-md\">\n                O administrador foi notificado! Você receberá um email assim que sua conta for ativada.\n            </p>\n        )}\n      </Card>\n    </div>\n  );\n};"
  },
  {
    "path": "components/DashboardPage.tsx",
    "content": "\nimport React from 'react';\nimport type { UserProfile, Book, Page, BookStatus } from '../types';\nimport { Button } from './ui/Button';\nimport { Card } from './ui/Card';\n\ninterface DashboardPageProps {\n  user: UserProfile;\n  books: Book[];\n  onNavigate: (page: Page) => void;\n  onLogout: () => void;\n  onViewBook: (bookId: string) => void;\n  logoUrl: string | null;\n}\n\nconst BookIcon = () => (\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"h-12 w-12 text-indigo-500 mb-2\"><path d=\"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20\"></path></svg>\n);\n\nconst bookStatusClasses: Record<BookStatus, string> = {\n    content_ready: 'bg-blue-100 text-blue-800',\n    // FIX: The 'processing_parts' and 'assembling_pdf' statuses were not defined in the BookStatus type. Renamed 'assembling_pdf' to 'generating_pdf' to match the type and added 'processing_parts' to the type definition.\n    processing_parts: 'bg-yellow-100 text-yellow-800 animate-pulse',\n    generating_pdf: 'bg-yellow-100 text-yellow-800 animate-pulse',\n    ready: 'bg-green-100 text-green-800',\n    error: 'bg-red-100 text-red-800',\n    generating_content: 'bg-gray-100 text-gray-800 animate-pulse'\n};\n\nconst formatBookStatus = (status: BookStatus) => {\n    const map: Record<BookStatus, string> = {\n        generating_content: 'Gerando...',\n        content_ready: 'Pronto para PDF',\n        // FIX: Renamed 'assembling_pdf' to 'generating_pdf' to align with the BookStatus type.\n        processing_parts: 'Processando...',\n        generating_pdf: 'Montando...',\n        ready: 'Pronto',\n        error: 'Erro'\n    };\n    return map[status] || status;\n};\n\n\nexport const DashboardPage: React.FC<DashboardPageProps> = ({ user, books, onNavigate, onLogout, onViewBook, logoUrl }) => {\n  const isFreeUser = user.status === 'ativa_free';\n  const credits = user.book_credits;\n  const canCreateBook = credits > 0;\n\n  let creditsText;\n  if (isFreeUser) {\n    creditsText = `Você pode criar mais ${credits} ${credits === 1 ? 'livro' : 'livros'}.`;\n  } else { // ativa_pro\n    creditsText = `Você ainda pode criar ${credits} de 100 livros este mês.`;\n  }\n\n  let createButtonText = \"+ Criar Novo Livro\";\n  if (!canCreateBook && isFreeUser) {\n    createButtonText = \"Faça upgrade para criar mais livros!\";\n  }\n\n  const userBooks = user.role === 'admin' ? books : books.filter(b => b.user_id === user.id);\n\n  return (\n    <div className=\"min-h-screen bg-gray-100\">\n      <header className=\"bg-white shadow-sm\">\n        <nav className=\"container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center\">\n          <img src={logoUrl || '/logo.png'} alt=\"LIDIA Logo\" className=\"h-10\" />\n          <div className=\"flex items-center space-x-4\">\n             {user.role === 'admin' && <Button onClick={() => onNavigate('admin-users')} variant=\"secondary\">Admin</Button>}\n            <span className=\"text-gray-600 hidden sm:block\">Olá, {user.email}</span>\n            <Button onClick={onLogout} variant=\"secondary\">Sair</Button>\n          </div>\n        </nav>\n      </header>\n\n      <main className=\"container mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        <Card className=\"mb-8\">\n          <div className=\"flex flex-col md:flex-row justify-between items-center\">\n            <div>\n                <h2 className=\"text-3xl font-bold text-gray-800\">Bem-vindo(a) de volta!</h2>\n                <p className=\"text-gray-600 mt-1\">{creditsText}</p>\n            </div>\n            <Button \n                onClick={() => onNavigate('create-book')} \n                className=\"mt-4 md:mt-0 text-lg\" \n                disabled={!canCreateBook}\n                title={!canCreateBook ? \"Você não tem créditos suficientes\" : \"Criar um novo livro\"}\n            >\n              {createButtonText}\n            </Button>\n          </div>\n        </Card>\n\n        <div>\n          <h3 className=\"text-2xl font-bold text-gray-700 mb-4\">Seus Livros Criados</h3>\n          {userBooks.length > 0 ? (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n              {userBooks.map(book => (\n                <Card key={book.id} className=\"flex flex-col\">\n                    <BookIcon />\n                  <h4 className=\"text-xl font-bold text-gray-800\">{book.title}</h4>\n                  <p className=\"text-gray-500 text-sm mt-1\">{book.subtitle}</p>\n                   <div className=\"flex justify-between items-center mt-2\">\n                        <p className=\"text-gray-500 text-xs\">Criado em: {new Date(book.created_at).toLocaleDateString()}</p>\n                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bookStatusClasses[book.status] || bookStatusClasses.content_ready}`}>\n                            {formatBookStatus(book.status)}\n                        </span>\n                   </div>\n                   <div className=\"mt-auto pt-4 flex space-x-2\">\n                       <Button onClick={() => onViewBook(book.id)} variant=\"secondary\" className=\"w-full text-sm py-2\">Visualizar e Gerar PDF</Button>\n                   </div>\n                </Card>\n              ))}\n            </div>\n          ) : (\n            <Card className=\"text-center\">\n              <p className=\"text-gray-500\">Você ainda não criou nenhum livro. Clique em \"Criar Novo Livro\" para começar!</p>\n            </Card>\n          )}\n        </div>\n      </main>\n    </div>\n  );\n};"
  },
  {
    "path": "components/CreateBookPage.tsx",
    "content": "\nimport React, { useState, useRef, useEffect } from 'react';\nimport type { UserProfile, BookGenerationFormData, Page } from '../types';\nimport { Button } from './ui/Button';\nimport { Input, TextArea } from './ui/Input';\nimport { Card } from './ui/Card';\nimport { generateBookContent } from '../services/bookGenerator';\n\nconst ArrowLeftIcon = () => (\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"h-5 w-5 mr-2\"><path d=\"m12 19-7-7 7-7\"/><path d=\"M19 12H5\"/></svg>\n);\n\ninterface CreateBookPageProps {\n  user: UserProfile;\n  onGenerationComplete: (newBookId: string) => Promise<void>;\n  onNavigate: (page: Page) => void;\n  onBeforeGenerate: () => Promise<{ allow: boolean; message: string }>;\n}\n\nexport const CreateBookPage: React.FC<CreateBookPageProps> = ({ user, onGenerationComplete, onNavigate, onBeforeGenerate }) => {\n  const [formData, setFormData] = useState<BookGenerationFormData>({\n    title: '',\n    subtitle: '',\n    author: user.email?.split('@')[0] || 'Autor',\n    language: 'Português (Brasil)',\n    tone: 'Inspirador e prático',\n    niche: 'Desenvolvimento Pessoal',\n    summary: '',\n  });\n  const [log, setLog] = useState<string[]>([]);\n  const [generationState, setGenerationState] = useState<'idle' | 'generating' | 'success' | 'error'>('idle');\n  const [errorMessage, setErrorMessage] = useState('');\n  const logContainerRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    if (logContainerRef.current) {\n      logContainerRef.current.scrollTop = logContainerRef.current.scrollHeight;\n    }\n  }, [log]);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n    const { name, value } = e.target;\n    setFormData(prev => ({ ...prev, [name]: value }));\n  };\n\n  const updateLog = (message: string) => {\n    setLog(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${message}`]);\n  };\n  \n  const handleGenerateBook = async () => {\n    const { allow, message } = await onBeforeGenerate();\n    if (!allow) {\n        setErrorMessage(message);\n        setGenerationState('error');\n        return;\n    }\n\n    setLog([]);\n    setErrorMessage('');\n    setGenerationState('generating');\n\n    try {\n      const newBookId = await generateBookContent(formData, user, updateLog);\n      \n      await onGenerationComplete(newBookId);\n\n      updateLog(\"Livro criado com sucesso! Redirecionando para a página de visualização.\");\n      setGenerationState('success');\n\n    } catch (error) {\n        console.error(\"Erro ao gerar o livro:\", error);\n        const err = error as Error;\n        updateLog(`Falha na geração: ${err.message}`);\n        setErrorMessage(`Ocorreu um erro: ${err.message}. Verifique o console para mais detalhes.`);\n        setGenerationState('error');\n    }\n  };\n\n  const isFormValid = formData.title && formData.summary && formData.niche;\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8\">\n      <div className=\"max-w-7xl mx-auto\">\n        <header className=\"mb-6 flex justify-between items-center\">\n          <Button onClick={() => onNavigate('dashboard')} variant=\"secondary\" className=\"inline-flex items-center\">\n            <ArrowLeftIcon />\n            Voltar ao Dashboard\n          </Button>\n        </header>\n        <main>\n          <Card>\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\n              {/* Coluna do Formulário */}\n              <div>\n                <h1 className=\"text-3xl font-bold text-gray-800 mb-2\">Criar Novo Livro</h1>\n                <p className=\"text-gray-600 mb-6\">Preencha os detalhes abaixo para a IA gerar seu e-book.</p>\n                \n                <form className=\"space-y-4\" onSubmit={(e) => { e.preventDefault(); handleGenerateBook(); }}>\n                  <Input name=\"title\" label=\"Sugestão de Título *\" value={formData.title} onChange={handleInputChange} placeholder=\"Ex: O Guia Definitivo do Marketing Digital\" required />\n                  <Input name=\"subtitle\" label=\"Subtítulo\" value={formData.subtitle} onChange={handleInputChange} placeholder=\"Ex: Estratégias para alavancar seu negócio online\" />\n                  <Input name=\"author\" label=\"Autor(es)\" value={formData.author} onChange={handleInputChange} required />\n                  <TextArea name=\"summary\" label=\"Resumo do Conteúdo *\" value={formData.summary} onChange={handleInputChange} placeholder=\"Descreva sobre o que é o livro, os principais tópicos que devem ser abordados, e o público-alvo.\" required rows={6} />\n                  <Input name=\"niche\" label=\"Nicho/Assunto Principal *\" value={formData.niche} onChange={handleInputChange} placeholder=\"Ex: Marketing para pequenas empresas, Culinária vegana, etc.\" required />\n                  <Input name=\"tone\" label=\"Tom de Voz\" value={formData.tone} onChange={handleInputChange} placeholder=\"Ex: Inspirador e prático, formal e acadêmico, divertido e casual\" />\n                  <Input name=\"language\" label=\"Idioma\" value={formData.language} onChange={handleInputChange} />\n                  <Button \n                    type=\"submit\" \n                    className=\"w-full text-lg\" \n                    isLoading={generationState === 'generating'}\n                    loadingText=\"Gerando seu livro...\"\n                    disabled={!isFormValid || generationState === 'generating'}\n                  >\n                    Gerar Livro com IA\n                  </Button>\n                </form>\n              </div>\n\n              {/* Coluna de Status e Resultado */}\n              <div className=\"flex flex-col\">\n                <h2 className=\"text-2xl font-bold text-gray-800 mb-4\">Status da Geração</h2>\n                <div ref={logContainerRef} className=\"bg-gray-900 text-white font-mono text-sm p-4 rounded-lg h-96 overflow-y-auto mb-4 flex-grow\">\n                  {log.length === 0 && <p className=\"text-gray-400\">Aguardando início da geração...</p>}\n                  {log.map((line, index) => <p key={index} className=\"whitespace-pre-wrap\">{line}</p>)}\n                </div>\n\n                {generationState === 'error' && (\n                  <Card className=\"border-2 border-red-300 bg-red-50\">\n                    <h3 className=\"text-lg font-bold text-red-800\">Erro na Geração</h3>\n                    <p className=\"text-red-700 mt-2\">{errorMessage}</p>\n                  </Card>\n                )}\n\n                {generationState === 'success' && (\n                  <Card className=\"border-2 border-green-300 bg-green-50\">\n                    <h3 className=\"text-lg font-bold text-green-800\">Conteúdo Gerado!</h3>\n                    <p className=\"text-green-700 mt-2 mb-4\">Seu livro foi criado e está pronto para a geração do PDF. Você será redirecionado em instantes.</p>\n                  </Card>\n                )}\n              </div>\n            </div>\n          </Card>\n        </main>\n      </div>\n    </div>\n  );\n};"
  },
  {
    "path": "components/admin/UserManagementPage.tsx",
    "content": "\n\n\n\n\nimport React, { useState, useEffect } from 'react';\nimport type { UserProfile, Page, UserStatus } from '../../types';\nimport { Button } from '../ui/Button';\nimport { Card } from '../ui/Card';\n\ninterface UserManagementPageProps {\n  users: UserProfile[];\n  onUpdateUser: (userId: string, status: UserStatus) => Promise<void>;\n  onNavigate: (page: Page) => void;\n}\n\n// FIX: Added missing status types 'ativa_starter' and 'ativa_premium' to align with the UserStatus type.\nconst statusClasses: Record<UserStatus, string> = {\n    ativa_pro: 'bg-indigo-100 text-indigo-800',\n    ativa_free: 'bg-green-100 text-green-800',\n    suspensa: 'bg-red-100 text-red-800',\n    aguardando_ativacao: 'bg-yellow-100 text-yellow-800',\n    ativa_starter: 'bg-blue-100 text-blue-800',\n    ativa_premium: 'bg-purple-100 text-purple-800',\n};\n\nconst formatStatus = (status: UserStatus) => {\n    return status.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n};\n\nexport const UserManagementPage: React.FC<UserManagementPageProps> = ({ users, onUpdateUser, onNavigate }) => {\n  const [openDropdown, setOpenDropdown] = useState<string | null>(null);\n  const [updatingUserId, setUpdatingUserId] = useState<string | null>(null);\n\n  useEffect(() => {\n    const handleClickOutside = () => {\n      setOpenDropdown(null);\n    };\n\n    document.addEventListener('click', handleClickOutside);\n    return () => {\n      document.removeEventListener('click', handleClickOutside);\n    };\n  }, []);\n\n  const availableStatuses: UserStatus[] = ['ativa_free', 'ativa_starter', 'ativa_pro', 'ativa_premium', 'suspensa'];\n\n  const handleStatusChange = async (userId: string, status: UserStatus) => {\n    setOpenDropdown(null);\n    setUpdatingUserId(userId);\n    try {\n      await onUpdateUser(userId, status);\n    } catch (error) {\n      console.error(\"Failed to update user status:\", error);\n    } finally {\n      setUpdatingUserId(null);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8\">\n      <header className=\"max-w-7xl mx-auto mb-8 flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-800\">Gestão de Usuários</h1>\n          <p className=\"text-gray-600\">Ative ou suspenda contas de usuários.</p>\n        </div>\n        <div className=\"flex space-x-2\">\n            <Button onClick={() => onNavigate('admin-activation')} variant=\"secondary\">Ativações Pendentes</Button>\n            <Button onClick={() => onNavigate('admin-settings')} variant=\"secondary\">Configurações</Button>\n            <Button onClick={() => onNavigate('dashboard')}>Dashboard</Button>\n        </div>\n      </header>\n      <main className=\"max-w-7xl mx-auto\">\n        <Card>\n          <div className=\"overflow-x-auto\">\n            <table className=\"min-w-full divide-y divide-gray-200\">\n              <thead className=\"bg-gray-50\">\n                <tr>\n                  <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Email</th>\n                  <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Status</th>\n                  <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Créditos</th>\n                  <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Ações</th>\n                </tr>\n              </thead>\n              <tbody className=\"bg-white divide-y divide-gray-200\">\n                {users.filter(u => u.role !== 'admin').map(user => (\n                  <tr key={user.id}>\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800\">{user.email || user.id}</td>\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm\">\n                      <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClasses[user.status]}`}>\n                        {formatStatus(user.status)}\n                      </span>\n                    </td>\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">{user.book_credits}</td>\n                    <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium\">\n                       {updatingUserId === user.id ? (\n                        <div className=\"flex items-center text-gray-500 text-xs\">\n                           <svg className=\"animate-spin mr-2 h-4 w-4 text-gray-400\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                                <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                                <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                            </svg>\n                          Salvando...\n                        </div>\n                      ) : (\n                        <div className=\"relative inline-block text-left\">\n                          <div>\n                            <Button\n                              variant=\"secondary\"\n                              className=\"py-1 px-3 text-xs\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                setOpenDropdown(openDropdown === user.id ? null : user.id);\n                              }}\n                            >\n                              Ações\n                            </Button>\n                          </div>\n                          {openDropdown === user.id && (\n                            <div className=\"origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20\">\n                              <div className=\"py-1\" role=\"menu\" aria-orientation=\"vertical\">\n                                {availableStatuses.map(status => (\n                                  <button\n                                    key={status}\n                                    onClick={() => handleStatusChange(user.id, status)}\n                                    disabled={user.status === status}\n                                    className=\"block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 disabled:opacity-50 disabled:bg-gray-200 disabled:cursor-not-allowed\"\n                                    role=\"menuitem\"\n                                  >\n                                    {formatStatus(status)}\n                                  </button>\n                                ))}\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </Card>\n      </main>\n    </div>\n  );\n};"
  },
  {
    "path": "components/admin/SettingsPage.tsx",
    "content": "\n\n\n\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport type { Page, PlanSetting } from '../../types';\nimport { Button } from '../ui/Button';\nimport { Card } from '../ui/Card';\nimport { Input } from '../ui/Input';\nimport { supabase } from '../../services/supabase';\n\ninterface Branding {\n    logoUrl: string | null;\n    faviconUrl: string | null;\n}\n\ninterface SettingsPageProps {\n  onNavigate: (page: Page) => void;\n  planSettings: PlanSetting[];\n  onUpdatePlanSettings: (updatedSettings: PlanSetting[]) => Promise<void>;\n  branding: Branding;\n  setBranding: React.Dispatch<React.SetStateAction<Branding>>;\n}\n\nexport const SettingsPage: React.FC<SettingsPageProps> = ({ onNavigate, planSettings, onUpdatePlanSettings, branding, setBranding }) => {\n  const [localSettings, setLocalSettings] = useState<PlanSetting[]>([]);\n  const [isSaving, setIsSaving] = useState(false);\n  const [saveMessage, setSaveMessage] = useState('');\n\n  const [logoFile, setLogoFile] = useState<File | null>(null);\n  const [faviconFile, setFaviconFile] = useState<File | null>(null);\n  const [isUploadingLogo, setIsUploadingLogo] = useState(false);\n  const [isUploadingFavicon, setIsUploadingFavicon] = useState(false);\n  const [uploadMessage, setUploadMessage] = useState('');\n\n  const logoInputRef = useRef<HTMLInputElement>(null);\n  const faviconInputRef = useRef<HTMLInputElement>(null);\n\n  useEffect(() => {\n    const sortedSettings = [...planSettings].sort((a, b) => a.plan_name.localeCompare(b.plan_name));\n    setLocalSettings(sortedSettings);\n  }, [planSettings]);\n\n  const handleCreditChange = (plan_id: string, value: string) => {\n    const credits = parseInt(value, 10);\n    if (isNaN(credits) || credits < 0) return;\n\n    setLocalSettings(prev =>\n      prev.map(setting =>\n        setting.plan_id === plan_id ? { ...setting, book_credits: credits } : setting\n      )\n    );\n  };\n\n  const handleSaveChanges = async () => {\n    setIsSaving(true);\n    setSaveMessage('');\n    try {\n      await onUpdatePlanSettings(localSettings);\n      setSaveMessage('Configurações salvas com sucesso!');\n      setTimeout(() => setSaveMessage(''), 3000);\n    } catch (error) {\n      setSaveMessage(`Erro ao salvar: ${(error as Error).message}`);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>, type: 'logo' | 'favicon') => {\n    if (e.target.files && e.target.files[0]) {\n      if (type === 'logo') setLogoFile(e.target.files[0]);\n      else setFaviconFile(e.target.files[0]);\n    }\n  };\n\n  const handleUpload = async (type: 'logo' | 'favicon') => {\n    const file = type === 'logo' ? logoFile : faviconFile;\n    if (!file) return;\n\n    if (type === 'logo') setIsUploadingLogo(true);\n    else setIsUploadingFavicon(true);\n    setUploadMessage('');\n\n    try {\n      const fileExt = file.name.split('.').pop();\n      const fileName = `${type}.${fileExt}`;\n      const filePath = `public/${fileName}`;\n\n      let { error: uploadError } = await supabase.storage\n        .from('branding')\n        .upload(filePath, file, {\n          cacheControl: '3600',\n          upsert: true,\n        });\n\n      if (uploadError) throw uploadError;\n\n      const { data: { publicUrl } } = supabase.storage.from('branding').getPublicUrl(filePath);\n\n      const columnToUpdate = type === 'logo' ? 'logo_url' : 'favicon_url';\n      \n      const { error: dbError } = await supabase\n        .from('branding')\n        .update({ [columnToUpdate]: publicUrl })\n        .eq('id', 1);\n      \n      if (dbError) throw dbError;\n\n      setBranding(prev => ({ ...prev, [type === 'logo' ? 'logoUrl' : 'faviconUrl']: publicUrl }));\n      setUploadMessage(`${type === 'logo' ? 'Logo' : 'Favicon'} atualizado com sucesso!`);\n      if (type === 'logo') setLogoFile(null);\n      else setFaviconFile(null);\n\n    } catch (error) {\n        setUploadMessage(`Erro no upload: ${(error as Error).message}`);\n    } finally {\n        if (type === 'logo') setIsUploadingLogo(false);\n        else setIsUploadingFavicon(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8\">\n      <header className=\"max-w-4xl mx-auto mb-8 flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-gray-800\">Configurações do Sistema</h1>\n          <p className=\"text-gray-600\">Gerencie planos, chaves de API e outras configurações.</p>\n        </div>\n         <div className=\"flex space-x-2\">\n            <Button onClick={() => onNavigate('admin-users')} variant=\"secondary\">Usuários</Button>\n            <Button onClick={() => onNavigate('dashboard')}>Dashboard</Button>\n        </div>\n      </header>\n      <main className=\"max-w-4xl mx-auto space-y-6\">\n      \n        <Card>\n          <h2 className=\"text-xl font-bold text-gray-700 mb-4\">Logo da Aplicação</h2>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 items-center\">\n            <div>\n              <p className=\"text-sm text-gray-600 mb-2\">Pré-visualização atual:</p>\n              <div className=\"bg-gray-200 p-4 rounded-lg flex justify-center items-center h-24\">\n                {branding.logoUrl ? <img src={branding.logoUrl} alt=\"Logo Preview\" className=\"max-h-16\" /> : <p className=\"text-gray-500\">Nenhum logo definido</p>}\n              </div>\n            </div>\n            <div>\n              <p className=\"text-sm text-gray-600 mb-2\">Fazer upload de novo logo:</p>\n              <p className=\"text-xs text-gray-500 mb-2\">Recomendado: 256x64 pixels, PNG com fundo transparente.</p>\n              <input type=\"file\" accept=\"image/png, image/jpeg\" ref={logoInputRef} onChange={(e) => handleFileSelect(e, 'logo')} className=\"hidden\" />\n              <Button variant=\"secondary\" onClick={() => logoInputRef.current?.click()}>Escolher arquivo</Button>\n              {logoFile && <span className=\"ml-3 text-sm text-gray-600\">{logoFile.name}</span>}\n              {logoFile && (\n                <Button onClick={() => handleUpload('logo')} isLoading={isUploadingLogo} loadingText=\"Enviando...\" className=\"mt-2 w-full\">\n                  Salvar Logo\n                </Button>\n              )}\n            </div>\n          </div>\n        </Card>\n        \n        <Card>\n          <h2 className=\"text-xl font-bold text-gray-700 mb-4\">Ícone do Navegador (Favicon)</h2>\n           <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 items-center\">\n            <div>\n              <p className=\"text-sm text-gray-600 mb-2\">Pré-visualização atual:</p>\n              <div className=\"bg-gray-200 p-4 rounded-lg flex justify-center items-center h-24\">\n                {branding.faviconUrl ? <img src={branding.faviconUrl} alt=\"Favicon Preview\" className=\"h-16 w-16\" /> : <p className=\"text-gray-500\">Nenhum ícone definido</p>}\n              </div>\n            </div>\n            <div>\n              <p className=\"text-sm text-gray-600 mb-2\">Fazer upload de novo ícone:</p>\n              <p className=\"text-xs text-gray-500 mb-2\">Recomendado: 64x64 pixels, formato PNG.</p>\n              <input type=\"file\" accept=\"image/png, image/x-icon\" ref={faviconInputRef} onChange={(e) => handleFileSelect(e, 'favicon')} className=\"hidden\" />\n              <Button variant=\"secondary\" onClick={() => faviconInputRef.current?.click()}>Escolher arquivo</Button>\n              {faviconFile && <span className=\"ml-3 text-sm text-gray-600\">{faviconFile.name}</span>}\n              {faviconFile && (\n                <Button onClick={() => handleUpload('favicon')} isLoading={isUploadingFavicon} loadingText=\"Enviando...\" className=\"mt-2 w-full\">\n                  Salvar Ícone\n                </Button>\n              )}\n            </div>\n          </div>\n        </Card>\n        \n        {uploadMessage && (\n            <p className={`text-center text-sm ${uploadMessage.includes('Erro') ? 'text-red-600' : 'text-green-600'}`}>{uploadMessage}</p>\n        )}\n\n        <Card>\n          <h2 className=\"text-xl font-bold text-gray-700 mb-4\">Gestão de Planos e Créditos</h2>\n          <p className=\"text-gray-600 mb-6 text-sm\">Defina quantos livros cada tipo de usuário pode criar. Isso será aplicado quando uma nova conta for ativada nesse plano.</p>\n          <div className=\"space-y-4\">\n            {localSettings.map(setting => (\n              <div key={setting.plan_id} className=\"grid grid-cols-3 items-center gap-4\">\n                <label htmlFor={`credits-${setting.plan_id}`} className=\"font-medium text-gray-700 col-span-1\">{setting.plan_name}</label>\n                <div className=\"col-span-2\">\n                  <Input\n                    id={`credits-${setting.plan_id}`}\n                    type=\"number\"\n                    label=\"\"\n                    value={setting.book_credits}\n                    onChange={(e) => handleCreditChange(setting.plan_id, e.target.value)}\n                    className=\"w-full\"\n                  />\n                </div>\n              </div>\n            ))}\n          </div>\n          <div className=\"mt-6 flex items-center justify-end space-x-4\">\n            {saveMessage && (\n              <p className={`text-sm ${saveMessage.includes('Erro') ? 'text-red-600' : 'text-green-600'}`}>{saveMessage}</p>\n            )}\n            <Button onClick={handleSaveChanges} isLoading={isSaving} loadingText=\"Salvando...\">\n              Salvar Alterações\n            </Button>\n          </div>\n        </Card>\n\n      </main>\n    </div>\n  );\n};"
  },
  {
    "path": "App.tsx",
    "content": "\n\n\n\n\nimport React, { useState, useEffect, useRef } from 'react';\nimport type { UserProfile, Book, Page, PlanSetting, UserStatus } from './types';\nimport { isSupabaseConfigured, supabase } from './services/supabase';\nimport { isGeminiConfigured } from './services/geminiConfig';\n\n// Dynamically import components to keep App.tsx clean\nimport { LandingPage } from './components/LandingPage';\nimport { AuthPage } from './components/AuthPage';\nimport { SuspendedAccountPage } from './components/SuspendedAccountPage';\nimport { DashboardPage } from './components/DashboardPage';\nimport { CreateBookPage } from './components/CreateBookPage';\nimport { UserManagementPage } from './components/admin/UserManagementPage';\nimport { SettingsPage } from './components/admin/SettingsPage';\nimport { ActivationPage } from './components/admin/ActivationPage';\nimport { ViewBookPage } from './components/ViewBookPage';\nimport { LoadingSpinner } from './components/ui/LoadingSpinner';\nimport { ConfigurationErrorPage } from './components/ConfigurationErrorPage';\nimport { AwaitingActivationPage } from './components/AwaitingActivationPage';\n\n\ninterface Branding {\n    logoUrl: string | null;\n    faviconUrl: string | null;\n}\n\nconst App: React.FC = () => {\n    const [user, setUser] = useState<UserProfile | null>(null);\n    const [page, setPage] = useState<Page>('landing');\n    const [users, setUsers] = useState<UserProfile[]>([]);\n    const [books, setBooks] = useState<Book[]>([]);\n    const [planSettings, setPlanSettings] = useState<PlanSetting[]>([]);\n    const [viewedBookId, setViewedBookId] = useState<string | null>(null);\n    const [authError, setAuthError] = useState<string | null>(null);\n    const [configErrors, setConfigErrors] = useState<('supabase' | 'gemini')[]>([]);\n    const [isConfigChecked, setIsConfigChecked] = useState(false);\n    const [branding, setBranding] = useState<Branding>({ logoUrl: null, faviconUrl: null });\n    const initialAuthCheckCompleted = useRef(false);\n\n    // Fetch branding on initial load\n    useEffect(() => {\n        const fetchBranding = async () => {\n            if (!isSupabaseConfigured) return;\n            const { data, error } = await supabase\n                .from('branding')\n                .select('logo_url, favicon_url')\n                .eq('id', 1)\n                .single();\n            \n            if (error) {\n                console.error(\"Error fetching branding:\", error);\n            } else if (data) {\n                setBranding({ logoUrl: data.logo_url, faviconUrl: data.favicon_url });\n            }\n        };\n\n        fetchBranding();\n    }, [isSupabaseConfigured]);\n\n    // Update favicon dynamically\n    useEffect(() => {\n        const favicon = document.querySelector(\"link[rel~='icon']\") as HTMLLinkElement;\n        if (favicon && branding.faviconUrl) {\n            favicon.href = branding.faviconUrl;\n        } else if (favicon && !branding.faviconUrl) {\n            favicon.href = '/favicon.png'; // Fallback\n        }\n    }, [branding.faviconUrl]);\n\n\n    useEffect(() => {\n        const missingKeys: ('supabase' | 'gemini')[] = [];\n        if (!isSupabaseConfigured) {\n            missingKeys.push('supabase');\n        }\n        if (!isGeminiConfigured) {\n            missingKeys.push('gemini');\n        }\n        setConfigErrors(missingKeys);\n        setIsConfigChecked(true);\n    }, []);\n\n    const handleNavigation = (currentUser: UserProfile) => {\n        if (currentUser.role === 'admin') {\n            setPage('dashboard');\n            return;\n        }\n        switch (currentUser.status) {\n            case 'ativa_pro':\n            case 'ativa_free':\n            case 'ativa_starter':\n            case 'ativa_premium':\n                setPage('dashboard');\n                break;\n            case 'suspensa':\n                setPage('suspended-account');\n                break;\n            case 'aguardando_ativacao':\n                setPage('awaiting-activation');\n                break;\n            default:\n                console.warn(`Unhandled user status: ${currentUser.status}. Defaulting to login.`);\n                setPage('login');\n                break;\n        }\n    };\n    \n    const fetchPlanSettings = async () => {\n        const { data, error } = await supabase.from('plan_settings').select('*');\n        if (error) {\n            console.error(\"Error fetching plan settings:\", error);\n        } else {\n            setPlanSettings(data as PlanSetting[]);\n        }\n    };\n\n    useEffect(() => {\n        if (!isSupabaseConfigured) {\n            if (initialAuthCheckCompleted.current === false) {\n                 initialAuthCheckCompleted.current = true;\n            }\n            return;\n        };\n        \n        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (_event, session) => {\n            if (!initialAuthCheckCompleted.current) {\n                initialAuthCheckCompleted.current = true;\n                return;\n            }\n\n            if (session?.user) {\n                if (user && session.user.id === user.id) {\n                    return;\n                }\n\n                setPage('loading');\n                let { data: profile, error: profileError } = await supabase\n                    .from('profiles')\n                    .select('*')\n                    .eq('id', session.user.id)\n                    .single();\n\n                if (profileError || !profile) {\n                    console.error(\"Failed to fetch profile after login:\", profileError);\n                    await supabase.auth.signOut();\n                    setAuthError(\"Não foi possível carregar seu perfil. Tente novamente.\");\n                    setPage('login');\n                    setUser(null);\n                    return;\n                }\n                \n                const userWithEmail = { ...profile, email: session.user.email };\n                setUser(userWithEmail);\n                handleNavigation(userWithEmail);\n\n            } else {\n                setUser(null);\n                setPage('landing');\n            }\n        });\n\n        return () => {\n            subscription.unsubscribe();\n        };\n    }, [isSupabaseConfigured, user]);\n\n\n    const fetchUserProfile = async () => {\n        if(!user) return;\n        let { data: profile, error } = await supabase\n            .from('profiles')\n            .select('*')\n            .eq('id', user.id)\n            .single();\n        if (error) {\n            console.error(\"Error fetching user profile\", error);\n        } else if (profile) {\n            setUser({ ...profile, email: user.email });\n        }\n    };\n\n    useEffect(() => {\n        if (user) {\n            fetchBooks();\n            fetchPlanSettings();\n            if (user.role === 'admin') {\n                fetchAllUsers();\n            }\n        } else {\n            setBooks([]);\n            setUsers([]);\n            setPlanSettings([]);\n        }\n    }, [user]);\n\n    const fetchBooks = async () => {\n        if (!user) return;\n        let query = supabase.from('books').select('*');\n        if (user.role !== 'admin') {\n            query = query.eq('user_id', user.id);\n        }\n        const { data, error } = await query.order('created_at', { ascending: false });\n        if (error) console.error(\"Error fetching books\", error);\n        else setBooks(data || []);\n    };\n    \n    const fetchAllUsers = async () => {\n        const { data, error } = await supabase\n            .from('profiles')\n            .select('id, email, status, role, book_credits')\n             .order('created_at', { ascending: false });\n        if (error) console.error(\"Error fetching users\", error);\n        else setUsers(data || []);\n    };\n\n    const handleLogout = async () => {\n        const { error } = await supabase.auth.signOut();\n        if (error) console.error(\"Error during sign out:\", error);\n    };\n    \n    const handleNavigate = (newPage: Page) => {\n        if (newPage.startsWith('admin-') && user?.role !== 'admin') {\n            setPage('dashboard');\n            return;\n        }\n        if (newPage === 'dashboard') {\n            fetchBooks();\n        }\n        setPage(newPage);\n    };\n\n    const handleUpdateUser = async (userId: string, status: UserStatus) => {\n        const plan = planSettings.find(p => p.plan_id === status);\n        const credits = status === 'suspensa' ? 0 : (plan ? plan.book_credits : 0);\n\n        const { error } = await supabase\n            .from('profiles')\n            .update({ status: status, book_credits: credits })\n            .eq('id', userId);\n        \n        if (error) {\n            console.error(\"Error updating user:\", error);\n            alert(`Erro ao atualizar o usuário: ${error.message}\\n\\nPossível causa: Verifique se as políticas de segurança (RLS) no Supabase permitem que administradores modifiquem perfis de usuários.`);\n            throw error;\n        }\n        \n        await fetchAllUsers();\n    };\n    \n    const handleGenerationComplete = async (newBookId: string) => {\n        await fetchBooks();\n        await fetchUserProfile();\n        setViewedBookId(newBookId);\n        setPage('view-book');\n    };\n    \n    const handleUpdatePlanSettings = async (updatedSettings: PlanSetting[]) => {\n        if(user?.role !== 'admin') throw new Error(\"Apenas administradores podem alterar as configurações.\");\n        \n        const { error } = await supabase.from('plan_settings').upsert(updatedSettings);\n\n        if (error) {\n            console.error(\"Error updating plan settings:\", error);\n            throw error;\n        }\n        \n        await fetchPlanSettings();\n    };\n\n     const handleViewBook = (bookId: string) => {\n        setViewedBookId(bookId);\n        setPage('view-book');\n    };\n\n    const handleBeforeGenerate = async (): Promise<{ allow: boolean; message: string }> => {\n        if (!user) {\n            return { allow: false, message: \"Usuário não autenticado.\" };\n        }\n        if (user.status === 'ativa_free' && user.book_credits <= 0) {\n            return { allow: false, message: \"Limite de um livro gratuito excedido. Faça upgrade para criar mais.\" };\n        }\n        return { allow: true, message: \"\" };\n    };\n\n    const renderPage = () => {\n        if (!isConfigChecked) {\n            return (\n                <div className=\"min-h-screen flex justify-center items-center\">\n                    <LoadingSpinner />\n                </div>\n            );\n        }\n\n        if (configErrors.length > 0) {\n            return <ConfigurationErrorPage missingKeys={configErrors} />;\n        }\n\n        if (page === 'loading') {\n            return (\n                <div className=\"min-h-screen flex justify-center items-center\">\n                    <LoadingSpinner />\n                </div>\n            );\n        }\n\n        if (!user) {\n             return page === 'login' ? <AuthPage logoUrl={branding.logoUrl} initialError={authError} /> : <LandingPage logoUrl={branding.logoUrl} onNavigate={handleNavigate} />;\n        }\n\n        switch (page) {\n            case 'suspended-account':\n                return <SuspendedAccountPage logoUrl={branding.logoUrl} onLogout={handleLogout} />;\n            case 'awaiting-activation':\n                return <AwaitingActivationPage logoUrl={branding.logoUrl} user={user} onLogout={handleLogout} />;\n            case 'dashboard':\n                return <DashboardPage logoUrl={branding.logoUrl} user={user} books={books} onNavigate={handleNavigate} onLogout={handleLogout} onViewBook={handleViewBook} />;\n            case 'create-book':\n                return <CreateBookPage user={user} onGenerationComplete={handleGenerationComplete} onNavigate={handleNavigate} onBeforeGenerate={handleBeforeGenerate} />;\n            case 'view-book':\n                const bookToView = books.find(b => b.id === viewedBookId);\n                if (!bookToView) {\n                    handleNavigation(user);\n                    return <LoadingSpinner />;\n                }\n                return <ViewBookPage book={bookToView} onNavigate={handleNavigate} />;\n            case 'admin-users':\n                if (user.role !== 'admin') { handleNavigation(user); return null; }\n                return <UserManagementPage users={users} onUpdateUser={handleUpdateUser} onNavigate={handleNavigate} />;\n            case 'admin-activation':\n                if (user.role !== 'admin') { handleNavigation(user); return null; }\n                return <ActivationPage users={users} onUpdateUser={handleUpdateUser} onNavigate={handleNavigate} />;\n            case 'admin-settings':\n                if (user.role !== 'admin') { handleNavigation(user); return null; }\n                return <SettingsPage onNavigate={handleNavigate} planSettings={planSettings} onUpdatePlanSettings={handleUpdatePlanSettings} branding={branding} setBranding={setBranding} />;\n            default:\n                handleNavigation(user);\n                return <LoadingSpinner />;\n        }\n    };\n\n    return <div className=\"antialiased\">{renderPage()}</div>;\n};\n\nexport default App;"
  },
  {
    "path": "components/SuspendedAccountPage.tsx",
    "content": "\nimport React from 'react';\nimport { Button } from './ui/Button';\nimport { Card } from './ui/Card';\n\ninterface SuspendedAccountPageProps {\n  onLogout: () => void;\n  logoUrl: string | null;\n}\n\nexport const SuspendedAccountPage: React.FC<SuspendedAccountPageProps> = ({ onLogout, logoUrl }) => {\n  return (\n    <div className=\"min-h-screen bg-gray-100 flex flex-col justify-center items-center p-4\">\n       <header className=\"absolute top-0 left-0 right-0 p-4 flex justify-between items-center\">\n        <img src={logoUrl || '/logo.png'} alt=\"LIDIA Logo\" className=\"h-10\" />\n        <Button onClick={onLogout} variant=\"secondary\">Sair</Button>\n      </header>\n      <Card className=\"w-full max-w-lg text-center\">\n        <h2 className=\"text-2xl font-bold text-gray-800 mb-4\">Conta Suspensa</h2>\n        <p className=\"text-gray-600 mb-6\">\n          Sua conta está suspensa. Por favor, entre em contato com o suporte.\n        </p>\n      </Card>\n    </div>\n  );\n};"
  },
  {
    "path": "components/ViewBookPage.tsx",
    "content": "\nimport React, { useState, useRef, useEffect } from 'react';\nimport html2pdf from 'html2pdf.js';\nimport { PDFDocument, rgb, StandardFonts } from 'pdf-lib';\nimport { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, PageBreak } from 'docx';\nimport type { Book, BookPart } from '../types';\nimport { Button } from './ui/Button';\nimport { supabase } from '../services/supabase';\nimport { Card } from './ui/Card';\nimport { LoadingSpinner } from './ui/LoadingSpinner';\nimport { assembleFullHtml, assemblePartHtml } from '../services/bookFormatter';\n\n\nconst ArrowLeftIcon = () => (\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"h-5 w-5 mr-2\"><path d=\"m12 19-7-7 7-7\"/><path d=\"M19 12H5\"/></svg>\n);\nconst GenerateIcon = () => (\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"h-5 w-5 mr-2\"><path d=\"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z\"/><polyline points=\"14 2 14 8 20 8\"/><path d=\"m10 15-2-2 2-2\"/><path d=\"m14 15 2-2-2-2\"/></svg>\n);\n\nconst DocxIcon = () => (\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" className=\"h-5 w-5 mr-2\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/><polyline points=\"7 10 12 15 17 10\"/><line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\"/></svg>\n);\n\n\ninterface ViewBookPageProps {\n  book: Book;\n  onNavigate: (page: 'dashboard') => void;\n}\n\nexport const ViewBookPage: React.FC<ViewBookPageProps> = ({ book, onNavigate }) => {\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [isGeneratingDocx, setIsGeneratingDocx] = useState(false);\n  const [isTestingBackend, setIsTestingBackend] = useState(false);\n  const [isLoadingParts, setIsLoadingParts] = useState(true);\n  const [bookParts, setBookParts] = useState<BookPart[]>([]);\n  const [fullHtml, setFullHtml] = useState<string | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const [log, setLog] = useState<string[]>([]);\n  const iframeRef = useRef<HTMLIFrameElement>(null);\n  const logContainerRef = useRef<HTMLDivElement>(null);\n  \n  useEffect(() => {\n    if (logContainerRef.current) {\n      logContainerRef.current.scrollTop = logContainerRef.current.scrollHeight;\n    }\n  }, [log]);\n\n  useEffect(() => {\n    const fetchAndAssemble = async () => {\n      setIsLoadingParts(true);\n      setError(null);\n      try {\n        const { data: parts, error: fetchError } = await supabase\n          .from('book_parts')\n          .select('*')\n          .eq('book_id', book.id)\n          .order('part_index', { ascending: true });\n\n        if (fetchError) throw fetchError;\n        if (!parts || parts.length === 0) throw new Error(\"Nenhuma parte do livro foi encontrada.\");\n\n        setBookParts(parts as BookPart[]);\n        const assembledHtml = assembleFullHtml(book, parts as BookPart[]);\n        setFullHtml(assembledHtml);\n\n      } catch (err) {\n        console.error(\"Error fetching or assembling book parts:\", err);\n        setError(`Não foi possível carregar o conteúdo do livro: ${(err as Error).message}`);\n      } finally {\n        setIsLoadingParts(false);\n      }\n    };\n    fetchAndAssemble();\n  }, [book.id, book]);\n\n  const updateLog = (message: string) => {\n    setLog(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${message}`]);\n  };\n  \n  const handleTestBackendPdf = async () => {\n    if (!fullHtml) {\n        alert(\"O conteúdo HTML do livro ainda não foi gerado. Aguarde o carregamento da pré-visualização.\");\n        updateLog(\"❌ Tentativa de gerar PDF do backend falhou: HTML não disponível.\");\n        return;\n    }\n\n    setIsTestingBackend(true);\n    setLog([]); // Clear previous logs for this specific action\n    updateLog(`Enviando HTML completo (${(fullHtml.length / 1024).toFixed(1)} KB) para a função de backend...`);\n\n    try {\n        // FIX: Removed the invalid 'responseType' property. The backend function has been updated to return\n        // a JSON object with a base64-encoded PDF, which is compatible with the `invoke` helper.\n        const { data, error } = await supabase.functions.invoke<{pdfBase64: string}>(\"generate-pdf\", {\n            body: { html: fullHtml },\n        });\n\n        if (error) {\n            // Supabase wraps function errors. If it's a blob, it might contain a JSON error message.\n            if (error.context && error.context.blob) {\n                try {\n                    const errorJsonText = await error.context.blob.text();\n                    const errorObj = JSON.parse(errorJsonText);\n                    throw new Error(errorObj.error || errorObj.message || 'Erro desconhecido retornado pelo backend.');\n                } catch (parseError) {\n                    // Fallback if the blob isn't valid JSON\n                    throw new Error(error.message || 'Falha na comunicação com o backend.');\n                }\n            }\n            throw error;\n        }\n\n        updateLog(\"PDF recebido do backend. Preparando download...\");\n\n        // FIX: Decode the base64 string from the JSON response to create the PDF blob.\n        if (!data?.pdfBase64) {\n            throw new Error(\"A resposta do backend não continha os dados do PDF esperados.\");\n        }\n\n        const byteCharacters = atob(data.pdfBase64);\n        const byteNumbers = new Array(byteCharacters.length);\n        for (let i = 0; i < byteCharacters.length; i++) {\n            byteNumbers[i] = byteCharacters.charCodeAt(i);\n        }\n        const byteArray = new Uint8Array(byteNumbers);\n        const blob = new Blob([byteArray], { type: 'application/pdf' });\n\n        const link = document.createElement('a');\n        link.href = URL.createObjectURL(blob);\n        link.download = `${book.title.replace(/ /g, '_')}_backend.pdf`;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        \n        updateLog(\"✅ Download do PDF gerado pelo backend iniciado com sucesso!\");\n    } catch (err: any) {\n        console.error(\"Erro ao gerar PDF no backend:\", err);\n        updateLog(`❌ ERRO: ${err.message}`);\n        alert(`Erro ao gerar PDF no backend: ${err.message}`);\n    } finally {\n        setIsTestingBackend(false);\n    }\n};\n\nconst handleGeneratePdf = async () => {\n    if (bookParts.length === 0) {\n        alert(\"As partes do livro não estão carregadas. Tente novamente.\");\n        return;\n    }\n\n    setIsGenerating(true);\n    setLog([]);\n    updateLog(\"Iniciando pipeline de geração de PDF...\");\n\n    const generatedPdfBuffers: ArrayBuffer[] = [];\n\n    try {\n        // Itera sobre cada parte do livro na ordem correta para gerar os PDFs.\n        for (const part of bookParts) {\n            updateLog(`Gerando PDF para a parte '${part.part_type}' (índice ${part.part_index})...`);\n            \n            // A biblioteca html2pdf precisa de um documento HTML completo para funcionar.\n            const partFullHtml = assemblePartHtml(book, part);\n\n            // As opções definem o formato da página e a qualidade.\n            // A margem é crucial para a diagramação. A capa não tem margens.\n            // FIX: Explicitly type `margin` as a tuple. TypeScript infers `number[]` from the ternary operator,\n            // which doesn't satisfy html2pdf's expected `[number, number, number, number]` type for margins.\n            const margin: [number, number, number, number] = part.part_type === 'cover' ? [0,0,0,0] : [2.4, 2, 2.7, 2];\n            const opt = {\n                margin: margin, // [top, left, bottom, right] em cm\n                filename: `${part.part_type}.pdf`,\n                image: { type: 'jpeg' as const, quality: 0.98 },\n                html2canvas: { scale: 2, useCORS: true, logging: false },\n                jsPDF: { unit: 'cm', format: 'a5', orientation: 'portrait' as const }\n            };\n\n            // `html2pdf` lida com a paginação automaticamente para conteúdos longos.\n            const pdfBytes = await html2pdf().from(partFullHtml).set(opt).output('arraybuffer');\n            generatedPdfBuffers.push(pdfBytes);\n            \n            const tempDoc = await PDFDocument.load(pdfBytes);\n            updateLog(`... Sucesso (${tempDoc.getPageCount()} páginas)`);\n        }\n\n        // --- FASE FINAL: Montagem do Documento ---\n        updateLog(\"Todas as partes geradas. Iniciando montagem final do documento...\");\n        const finalPdfDoc = await PDFDocument.create();\n\n        for (const buffer of generatedPdfBuffers) {\n            const partPdfDoc = await PDFDocument.load(buffer);\n            const copiedPages = await finalPdfDoc.copyPages(partPdfDoc, partPdfDoc.getPageIndices());\n            copiedPages.forEach(page => finalPdfDoc.addPage(page));\n        }\n\n        updateLog(\"Adicionando cabeçalhos e numeração de página...\");\n        const pages = finalPdfDoc.getPages();\n        const helveticaFont = await finalPdfDoc.embedFont(StandardFonts.Helvetica);\n        const helveticaBoldFont = await finalPdfDoc.embedFont(StandardFonts.HelveticaBold);\n        const royalBlue = rgb(0, 0.137, 0.4);\n        const blackTransparent = rgb(0, 0, 0);\n\n        // Adiciona cabeçalho e rodapé em todas as páginas, exceto na primeira (capa).\n        for (let i = 0; i < pages.length; i++) {\n            const pageCounter = i + 1;\n            if (pageCounter > 1) { // Pula a capa\n                const page = pages[i];\n                const { width, height } = page.getSize();\n                \n                // Cabeçalho com o título do livro\n                const headerText = book.title.toUpperCase();\n                const headerTextWidth = helveticaFont.widthOfTextAtSize(headerText, 8);\n                page.drawText(headerText, {\n                    x: (width - headerTextWidth) / 2,\n                    y: height - 1.3 * 28.35, // 1.3cm do topo\n                    font: helveticaFont, size: 8, color: royalBlue,\n                });\n\n                // Rodapé com o número da página\n                const footerText = String(pageCounter);\n                const footerTextWidth = helveticaBoldFont.widthOfTextAtSize(footerText, 16);\n                page.drawText(footerText, {\n                    x: (width - footerTextWidth) / 2,\n                    y: 1.35 * 28.35, // 1.35cm da base\n                    font: helveticaBoldFont, size: 16, color: blackTransparent, opacity: 0.4,\n                });\n            }\n        }\n        \n        const finalPageCount = finalPdfDoc.getPageCount();\n        updateLog(`Montagem finalizada com ${finalPageCount} páginas. Preparando para download...`);\n        const finalPdfBytes = await finalPdfDoc.save();\n\n        const blob = new Blob([finalPdfBytes], { type: 'application/pdf' });\n        const link = document.createElement('a');\n        link.href = URL.createObjectURL(blob);\n        link.download = `${book.title.replace(/ /g, '_')}.pdf`;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        updateLog(\"Download iniciado. Processo concluído!\");\n\n    } catch (error) {\n        console.error(\"PDF Generation Pipeline Error:\", error);\n        const errMessage = `Ocorreu um erro: ${(error as Error).message}`;\n        updateLog(`ERRO: ${errMessage}`);\n        alert(errMessage);\n    } finally {\n        setIsGenerating(false);\n    }\n  };\n  \n  const handleGenerateDocx = async () => {\n    if (bookParts.length === 0) {\n        alert(\"As partes do livro não estão carregadas. Tente novamente.\");\n        return;\n    }\n    setIsGeneratingDocx(true);\n    updateLog(\"Iniciando geração do arquivo DOCX...\");\n\n    try {\n        const docChildren: (Paragraph | any)[] = [];\n\n        const createParagraphs = (text: string, firstParaNoIndent = false) => {\n            if (!text) return [];\n            const lines = text.split('\\n').filter(p => p.trim() !== '');\n            return lines.map((line, index) => {\n                // FIX: Explicitly typed `indentation` to allow an empty object, resolving the TypeScript error.\n                let indentation: { firstLine?: number } = { firstLine: 720 }; // 0.5 inch in twips\n                if (firstParaNoIndent && index === 0) {\n                    indentation = {}; \n                }\n                return new Paragraph({\n                    children: [new TextRun(line.trim())],\n                    style: \"default\",\n                    indent: indentation,\n                });\n            });\n        };\n\n        bookParts.forEach(part => {\n            let content;\n            try {\n                content = JSON.parse(part.content);\n            } catch (e) {\n                content = { content: part.content };\n            }\n\n            switch (part.part_type) {\n                case 'cover':\n                    docChildren.push(new Paragraph({\n                        children: [new TextRun({ text: content.title, bold: true, size: 72 })],\n                        alignment: AlignmentType.CENTER,\n                        spacing: { after: 400 }\n                    }));\n                    docChildren.push(new Paragraph({\n                        children: [new TextRun({ text: content.subtitle, size: 36, italics: true })],\n                        alignment: AlignmentType.CENTER,\n                        spacing: { after: 800 }\n                    }));\n                    docChildren.push(new Paragraph({\n                        children: [new TextRun({ text: content.author, size: 28 })],\n                        alignment: AlignmentType.CENTER\n                    }));\n                    docChildren.push(new Paragraph({ children: [new PageBreak()] }));\n                    break;\n                case 'copyright':\n                    const copyrightText = typeof content === 'string' ? content : (content.content || `Copyright © ${new Date().getFullYear()} ${book.author}`);\n                    docChildren.push(new Paragraph({\n                        children: [new TextRun({ text: copyrightText, size: 18 })],\n                        alignment: AlignmentType.CENTER,\n                    }));\n                    docChildren.push(new Paragraph({\n                        children: [new TextRun({ text: \"Todos os direitos reservados.\", size: 18 })],\n                        alignment: AlignmentType.CENTER,\n                    }));\n                     docChildren.push(new Paragraph({\n                        children: [new TextRun({ text: \"Este livro ou qualquer parte dele não pode ser reproduzido ou usado de forma alguma sem a permissão expressa por escrito do editor, exceto pelo uso de breves citações em uma resenha do livro.\", size: 18 })],\n                        alignment: AlignmentType.CENTER,\n                        spacing: { before: 200 }\n                    }));\n                    docChildren.push(new Paragraph({ children: [new PageBreak()] }));\n                    break;\n                case 'toc':\n                    docChildren.push(new Paragraph({ text: content.title, style: \"Heading1\", alignment: AlignmentType.LEFT }));\n                    content.content.split('\\n').forEach((line: string) => {\n                         line = line.trim();\n                         if (!line) return;\n                         const isChapter = line.match(/^capítulo \\d+:/i);\n                         docChildren.push(new Paragraph({\n                            children: [new TextRun({ text: line, bold: !!isChapter })],\n                            indent: isChapter ? {} : { left: 720 }\n                         }));\n                    });\n                    docChildren.push(new Paragraph({ children: [new PageBreak()] }));\n                    break;\n                case 'introduction':\n                case 'conclusion':\n                    docChildren.push(new Paragraph({ text: content.title, style: \"Heading1\" }));\n                    createParagraphs(content.content, false).forEach(p => docChildren.push(p));\n                    docChildren.push(new Paragraph({ children: [new PageBreak()] }));\n                    break;\n                case 'chapter_title':\n                     docChildren.push(new Paragraph({\n                        text: content.title,\n                        style: \"Heading1\",\n                        alignment: AlignmentType.CENTER,\n                        spacing: { before: 2000, after: 2000 }\n                    }));\n                    break;\n                case 'chapter_content':\n                     docChildren.push(new Paragraph({ text: content.title, style: \"Heading2\" }));\n                    createParagraphs(content.introduction, true).forEach(p => docChildren.push(p));\n                    content.subchapters.forEach((sub: any) => {\n                        docChildren.push(new Paragraph({ text: sub.title, style: \"Heading3\" }));\n                        createParagraphs(sub.content, true).forEach(p => docChildren.push(p));\n                    });\n                    docChildren.push(new Paragraph({ children: [new PageBreak()] }));\n                    break;\n                default:\n                    break;\n            }\n        });\n        updateLog(\"Estrutura do documento criada. Gerando o arquivo...\");\n\n        const doc = new Document({\n             styles: {\n                paragraphStyles: [\n                    {\n                        id: \"default\", name: \"Default\", basedOn: \"Normal\", next: \"Normal\", quickFormat: true,\n                        run: { font: \"Merriweather\", size: 25 }, // 12.5pt\n                        paragraph: { spacing: { after: 160 }, alignment: AlignmentType.JUSTIFIED }\n                    },\n                    {\n                        id: \"Heading1\", name: \"Heading 1\", basedOn: \"Normal\", next: \"Normal\", quickFormat: true,\n                        run: { font: \"Merriweather\", size: 56, bold: true }, // 28pt\n                        paragraph: { spacing: { before: 240, after: 120 } }\n                    },\n                    {\n                        id: \"Heading2\", name: \"Heading 2\", basedOn: \"Normal\", next: \"Normal\", quickFormat: true,\n                        run: { font: \"Merriweather\", size: 44, bold: true }, // 22pt\n                         paragraph: { spacing: { before: 240, after: 120 } }\n                    },\n                    {\n                        id: \"Heading3\", name: \"Heading 3\", basedOn: \"Normal\", next: \"Normal\", quickFormat: true,\n                        run: { font: \"Merriweather Sans\", size: 32, bold: true }, // 16pt\n                         paragraph: { spacing: { before: 240, after: 120 } }\n                    }\n                ]\n            },\n            sections: [{ children: docChildren }]\n        });\n\n        const blob = await Packer.toBlob(doc);\n        const link = document.createElement('a');\n        link.href = URL.createObjectURL(blob);\n        link.download = `${book.title.replace(/ /g, '_')}.docx`;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        updateLog(\"Download do DOCX iniciado. Processo concluído!\");\n    } catch (error) {\n        console.error(\"DOCX Generation Error:\", error);\n        const errMessage = `Ocorreu um erro ao gerar o DOCX: ${(error as Error).message}`;\n        updateLog(`ERRO: ${errMessage}`);\n        alert(errMessage);\n    } finally {\n        setIsGeneratingDocx(false);\n    }\n  }\n\n\n  return (\n    <div className=\"min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8\">\n      {/* O container de renderização foi removido pois não é mais necessário com a nova abordagem. */}\n      \n      <div className=\"max-w-7xl mx-auto\">\n        <header className=\"mb-6 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0\">\n            <Button onClick={() => onNavigate('dashboard')} variant=\"secondary\" className=\"inline-flex items-center w-full sm:w-auto\">\n                <ArrowLeftIcon />\n                Voltar\n            </Button>\n            <div className=\"text-sm text-gray-600\">\n                A edição de conteúdo foi desativada nesta versão para garantir a estabilidade da geração de PDF.\n            </div>\n        </header>\n\n        {error && (\n            <div className=\"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4\" role=\"alert\">\n                <strong className=\"font-bold\">Erro!</strong>\n                <span className=\"block sm:inline\"> {error}</span>\n            </div>\n        )}\n\n        <main className=\"grid grid-cols-1 lg:grid-cols-2 gap-8\">\n            <div className=\"lg:col-span-2 text-center\">\n                <h1 className=\"text-3xl font-bold text-gray-800 mb-1\">{book.title}</h1>\n                <h2 className=\"text-xl text-gray-600\">{book.subtitle}</h2>\n                <p className=\"text-sm text-gray-500 mt-1\">por {book.author}</p>\n            </div>\n            \n            <Card className=\"lg:col-span-2 text-center\">\n                <h3 className=\"text-xl font-bold text-gray-800\">Gerar Arquivos Finais</h3>\n                <p className=\"text-gray-600 mt-2\">Clique nos botões abaixo para gerar os arquivos do seu livro.</p>\n                <div className=\"mt-6 flex flex-col sm:flex-row justify-center items-center gap-4\">\n                    <Button \n                      onClick={handleGeneratePdf} \n                      className=\"text-lg w-full sm:w-auto\" \n                      isLoading={isGenerating || isLoadingParts}\n                      loadingText={isLoadingParts ? \"Carregando...\" : \"Gerando PDF...\"}\n                      disabled={isLoadingParts || !!error || isGenerating || isGeneratingDocx || isTestingBackend}\n                    >\n                        <GenerateIcon/>\n                        Gerar PDF Final\n                    </Button>\n                    <Button \n                      onClick={handleGenerateDocx} \n                      className=\"text-lg w-full sm:w-auto\" \n                      variant=\"secondary\"\n                      isLoading={isGeneratingDocx}\n                      loadingText=\"Gerando DOCX...\"\n                      disabled={isLoadingParts || !!error || isGenerating || isGeneratingDocx || isTestingBackend}\n                    >\n                        <DocxIcon/>\n                        Baixar .DOCX\n                    </Button>\n                    <Button \n                      onClick={handleTestBackendPdf} \n                      className=\"text-lg w-full sm:w-auto\" \n                      variant=\"secondary\"\n                      isLoading={isTestingBackend}\n                      loadingText=\"Testando...\"\n                      disabled={isLoadingParts || !!error || isGenerating || isGeneratingDocx || isTestingBackend}\n                    >\n                        Testar PDF Backend\n                    </Button>\n                </div>\n            </Card>\n\n            <div className=\"lg:col-span-2\">\n                 <h2 className=\"text-2xl font-bold text-gray-800 mb-4\">Log de Geração</h2>\n                 <div ref={logContainerRef} className=\"bg-gray-900 text-white font-mono text-sm p-4 rounded-lg h-64 overflow-y-auto mb-4 flex-grow\">\n                  {log.length === 0 && <p className=\"text-gray-400\">Aguardando início da geração...</p>}\n                  {log.map((line, index) => <p key={index} className=\"whitespace-pre-wrap\">{line}</p>)}\n                </div>\n            </div>\n\n            <div className=\"lg:col-span-2\">\n                <h2 className=\"text-2xl font-bold text-gray-800 mb-4\">Pré-visualização do Conteúdo</h2>\n                <div className=\"bg-white rounded-xl shadow-lg overflow-hidden\">\n                    {isLoadingParts ? (\n                        <div className=\"h-[80vh] flex justify-center items-center\"><LoadingSpinner/></div>\n                    ) : error ? (\n                         <div className=\"h-[80vh] flex justify-center items-center text-red-600 p-4\">{error}</div>\n                    ) : (\n                        <iframe\n                            ref={iframeRef}\n                            srcDoc={fullHtml || ''}\n                            title={book.title}\n                            className=\"w-full border-0 h-[80vh]\"\n                            sandbox=\"allow-scripts allow-same-origin\"\n                        />\n                    )}\n                </div>\n            </div>\n        </main>\n      </div>\n    </div>\n  );\n};"
  }
]
